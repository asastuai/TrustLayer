<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Status ‚Äî TrustLayer</title>
  <link rel="icon" type="image/png" href="/logo.png" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0a0a0f; color: #e2e8f0; font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; min-height: 100vh; }
    a { color: inherit; text-decoration: none; }
    nav { display: flex; align-items: center; justify-content: space-between; padding: 20px 40px; border-bottom: 1px solid rgba(255,255,255,0.06); background: rgba(10,10,15,0.9); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 100; }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 700; }
    .logo-icon { width: 32px; height: 32px; object-fit: contain; }
    .nav-links { display: flex; gap: 24px; font-size: 14px; color: #94a3b8; }
    .nav-links a:hover { color: #e2e8f0; }
    .nav-links a.active { color: #a5b4fc; }

    .container { max-width: 860px; margin: 0 auto; padding: 48px 24px; }
    .page-header { margin-bottom: 40px; }
    .page-title { font-size: 36px; font-weight: 800; margin-bottom: 8px; }
    .page-sub { color: #64748b; font-size: 16px; }

    /* SYSTEM STATUS BANNER */
    .status-banner { display: flex; align-items: center; gap: 14px; padding: 20px 24px; border-radius: 14px; margin-bottom: 40px; }
    .status-banner.up { background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.2); }
    .status-banner.down { background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); }
    .status-banner.partial { background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2); }
    .status-dot { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
    .status-dot.up { background: #10b981; box-shadow: 0 0 8px rgba(16,185,129,0.5); animation: pulse 2s infinite; }
    .status-dot.down { background: #ef4444; }
    .status-dot.partial { background: #f59e0b; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
    .status-text { flex: 1; }
    .status-main { font-size: 18px; font-weight: 700; }
    .status-sub { font-size: 13px; color: #64748b; margin-top: 2px; }
    .status-time { font-size: 12px; color: #475569; }

    /* SERVICES GRID */
    .services-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 16px; margin-bottom: 40px; }
    .service-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.07); border-radius: 12px; padding: 20px; }
    .service-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .service-icon { font-size: 20px; }
    .service-name { font-weight: 700; font-size: 16px; flex: 1; }
    .pill { font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 20px; }
    .pill.up { background: rgba(16,185,129,0.15); color: #34d399; }
    .pill.down { background: rgba(239,68,68,0.15); color: #f87171; }
    .pill.unknown { background: rgba(100,116,139,0.15); color: #94a3b8; }
    .service-metrics { display: flex; gap: 20px; }
    .metric { }
    .metric-val { font-size: 20px; font-weight: 700; }
    .metric-val.up { color: #34d399; }
    .metric-val.down { color: #f87171; }
    .metric-val.unknown { color: #64748b; }
    .metric-label { font-size: 11px; color: #64748b; margin-top: 2px; }

    /* REGISTERED SERVICES */
    .section-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
    .service-list { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.07); border-radius: 12px; overflow: hidden; }
    .service-row { display: flex; align-items: center; gap: 16px; padding: 14px 20px; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 14px; }
    .service-row:last-child { border-bottom: none; }
    .service-row-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .service-row-dot.up { background: #10b981; }
    .service-row-dot.down { background: #ef4444; }
    .service-row-name { flex: 1; font-weight: 500; }
    .service-row-url { color: #475569; font-size: 12px; font-family: monospace; flex: 2; }
    .service-row-latency { color: #94a3b8; font-size: 13px; min-width: 60px; text-align: right; }
    .service-row-status { font-size: 12px; font-weight: 600; min-width: 40px; text-align: right; }
    .service-row-status.up { color: #34d399; }
    .service-row-status.down { color: #f87171; }

    .register-box { background: rgba(99,102,241,0.05); border: 1px solid rgba(99,102,241,0.15); border-radius: 12px; padding: 24px; margin-top: 24px; }
    .register-title { font-weight: 700; margin-bottom: 8px; }
    .register-desc { font-size: 14px; color: #64748b; margin-bottom: 16px; }
    .input-row { display: flex; gap: 10px; flex-wrap: wrap; }
    input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 14px; color: #e2e8f0; font-size: 14px; flex: 1; min-width: 200px; outline: none; }
    input:focus { border-color: rgba(99,102,241,0.5); }
    input::placeholder { color: #475569; }
    button { background: linear-gradient(135deg, #6366f1, #a855f7); border: none; border-radius: 8px; padding: 10px 20px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    .register-success { color: #34d399; font-size: 14px; margin-top: 10px; display: none; }
    .register-error { color: #f87171; font-size: 14px; margin-top: 10px; display: none; }

    .loading { color: #475569; font-style: italic; padding: 20px; text-align: center; }
    .last-updated { font-size: 12px; color: #475569; margin-top: 6px; }
  </style>
</head>
<body>
  <nav>
    <a class="logo" href="/">
      <img class="logo-icon" src="/logo.png" alt="TrustLayer" />
      TrustLayer
    </a>
    <div class="nav-links">
      <a href="/docs">API Docs</a>
      <a href="/status" class="active">Live Status</a>
      <a href="https://github.com/asastuai/TrustLayer" target="_blank">GitHub</a>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <div class="page-title">Live Status</div>
      <p class="page-sub">Real-time monitoring of TrustLayer services and registered x402 agents.</p>
    </div>

    <!-- System Banner -->
    <div id="system-banner" class="status-banner up">
      <div class="status-dot up" id="system-dot"></div>
      <div class="status-text">
        <div class="status-main" id="system-text">Loading...</div>
        <div class="status-sub" id="system-sub">Checking services...</div>
      </div>
      <div class="status-time" id="system-time"></div>
    </div>

    <!-- TrustLayer Own Services -->
    <div class="section-title">TrustLayer Infrastructure</div>
    <div class="services-grid" id="infra-grid">
      <div class="service-card">
        <div class="service-card-header">
          <span class="service-icon">üõ°Ô∏è</span>
          <span class="service-name">ClawScan</span>
          <span class="pill up" id="clawscan-pill">Checking...</span>
        </div>
        <div class="service-metrics">
          <div class="metric"><div class="metric-val up" id="clawscan-latency">‚Äî</div><div class="metric-label">Latency</div></div>
          <div class="metric"><div class="metric-val up" id="clawscan-status">‚Äî</div><div class="metric-label">Status</div></div>
        </div>
      </div>
      <div class="service-card">
        <div class="service-card-header">
          <span class="service-icon">üß™</span>
          <span class="service-name">QABot</span>
          <span class="pill up" id="qabot-pill">Checking...</span>
        </div>
        <div class="service-metrics">
          <div class="metric"><div class="metric-val up" id="qabot-latency">‚Äî</div><div class="metric-label">Latency</div></div>
          <div class="metric"><div class="metric-val up" id="qabot-status">‚Äî</div><div class="metric-label">Status</div></div>
        </div>
      </div>
      <div class="service-card">
        <div class="service-card-header">
          <span class="service-icon">üì°</span>
          <span class="service-name">Sentinel</span>
          <span class="pill up" id="sentinel-pill">Checking...</span>
        </div>
        <div class="service-metrics">
          <div class="metric"><div class="metric-val up" id="sentinel-latency">‚Äî</div><div class="metric-label">Latency</div></div>
          <div class="metric"><div class="metric-val up" id="sentinel-status">‚Äî</div><div class="metric-label">Status</div></div>
        </div>
      </div>
      <div class="service-card">
        <div class="service-card-header">
          <span class="service-icon">üîê</span>
          <span class="service-name">ClawVault</span>
          <span class="pill up" id="clawvault-pill">Checking...</span>
        </div>
        <div class="service-metrics">
          <div class="metric"><div class="metric-val up" id="clawvault-latency">‚Äî</div><div class="metric-label">Latency</div></div>
          <div class="metric"><div class="metric-val up" id="clawvault-status">‚Äî</div><div class="metric-label">Status</div></div>
        </div>
      </div>
    </div>

    <!-- Registered Services -->
    <div class="section-title" style="margin-top:40px">Monitored Services</div>
    <div id="monitored-list">
      <div class="loading">Loading monitored services...</div>
    </div>

    <!-- Register Box -->
    <div class="register-box">
      <div class="register-title">Register your service for monitoring</div>
      <div class="register-desc">Add any x402 service URL to get free uptime tracking, latency history, and a spot on the leaderboard.</div>
      <div class="input-row">
        <input type="url" id="reg-url" placeholder="https://your-agent.up.railway.app" />
        <input type="text" id="reg-name" placeholder="Service name (optional)" style="max-width:200px" />
        <button id="reg-btn" onclick="registerService()">Monitor it</button>
      </div>
      <div class="register-success" id="reg-success">‚úÖ Registered! First results in ~60 seconds.</div>
      <div class="register-error" id="reg-error"></div>
    </div>
  </div>

  <script>
    const BASE = '';

    async function checkHealth() {
      const start = Date.now();
      try {
        const r = await fetch(BASE + '/api/v1/health');
        const latency = Date.now() - start;
        return { up: r.ok, latency, status: r.status };
      } catch {
        return { up: false, latency: null, status: 0 };
      }
    }

    function setPill(id, up) {
      const el = document.getElementById(id);
      el.textContent = up ? 'Operational' : 'Down';
      el.className = 'pill ' + (up ? 'up' : 'down');
    }

    function setMetric(latencyId, statusId, data) {
      document.getElementById(latencyId).textContent = data.latency ? data.latency + 'ms' : 'N/A';
      document.getElementById(statusId).textContent = data.up ? 'UP' : 'DOWN';
      document.getElementById(statusId).className = 'metric-val ' + (data.up ? 'up' : 'down');
    }

    async function loadStatus() {
      // Check own health
      const health = await checkHealth();

      // Update banner
      const banner = document.getElementById('system-banner');
      const dot = document.getElementById('system-dot');
      banner.className = 'status-banner ' + (health.up ? 'up' : 'down');
      dot.className = 'status-dot ' + (health.up ? 'up' : 'down');
      document.getElementById('system-text').textContent = health.up
        ? 'All Systems Operational' : 'Service Disruption';
      document.getElementById('system-sub').textContent = health.up
        ? 'TrustLayer API is responding normally'
        : 'TrustLayer API is not responding';
      document.getElementById('system-time').textContent = 'Updated ' + new Date().toLocaleTimeString();

      // All 4 internal services share the same server for now
      ['clawscan','qabot','sentinel','clawvault'].forEach(id => {
        setPill(id + '-pill', health.up);
        setMetric(id + '-latency', id + '-status', health);
      });

      // Load monitored services
      try {
        const r = await fetch(BASE + '/api/v1/sla/live');
        const services = await r.json();
        const container = document.getElementById('monitored-list');
        if (!services.length) {
          container.innerHTML = '<div class="loading">No services registered yet. Be the first!</div>';
          return;
        }
        container.innerHTML = '<div class="service-list">' + services.map(s => `
          <div class="service-row">
            <div class="service-row-dot ${s.status === 'UP' ? 'up' : 'down'}"></div>
            <div class="service-row-name">${s.name || 'Unnamed'}</div>
            <div class="service-row-url">${s.url}</div>
            <div class="service-row-latency">${s.last_latency_ms ? s.last_latency_ms + 'ms' : '‚Äî'}</div>
            <div class="service-row-status ${s.status === 'UP' ? 'up' : 'down'}">${s.status}</div>
          </div>`).join('') + '</div>';
      } catch (e) {
        document.getElementById('monitored-list').innerHTML = '<div class="loading">Could not load monitored services.</div>';
      }
    }

    async function registerService() {
      const url = document.getElementById('reg-url').value.trim();
      const name = document.getElementById('reg-name').value.trim();
      const btn = document.getElementById('reg-btn');
      const success = document.getElementById('reg-success');
      const error = document.getElementById('reg-error');

      if (!url) { error.textContent = 'Please enter a URL.'; error.style.display = 'block'; return; }
      btn.disabled = true; btn.textContent = 'Registering...';
      success.style.display = 'none'; error.style.display = 'none';

      try {
        const r = await fetch(BASE + '/api/v1/sla/register', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ url, name: name || null })
        });
        if (r.ok) {
          success.style.display = 'block';
          document.getElementById('reg-url').value = '';
          document.getElementById('reg-name').value = '';
          setTimeout(loadStatus, 2000);
        } else {
          const d = await r.json();
          error.textContent = d.error || 'Registration failed.';
          error.style.display = 'block';
        }
      } catch (e) {
        error.textContent = 'Network error. Try again.';
        error.style.display = 'block';
      }
      btn.disabled = false; btn.textContent = 'Monitor it';
    }

    loadStatus();
    setInterval(loadStatus, 30000); // refresh every 30s
  </script>
</body>
</html>
